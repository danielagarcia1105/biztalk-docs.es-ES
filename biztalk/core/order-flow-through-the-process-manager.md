---
title: Ordenar por el Administrador de procesos de flujo | Documentos de Microsoft
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
helpviewer_keywords:
- process management solution tutorial, processing
- processing, processing logic
ms.assetid: e2b51eff-44b5-440f-a7d1-0872543e5f27
caps.latest.revision: 30
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 8556bce43ba4a951d0045d22f76d4bd222fcd8f2
ms.sourcegitcommit: cb908c540d8f1a692d01dc8f313e16cb4b4e696d
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 09/20/2017
ms.locfileid: "22266660"
---
# <a name="order-flow-through-the-process-manager"></a><span data-ttu-id="260b7-102">Flujo de pedidos a través del Administrador de proceso</span><span class="sxs-lookup"><span data-stu-id="260b7-102">Order Flow through the Process Manager</span></span>
<span data-ttu-id="260b7-103">Esta sección describe cómo el Administrador de procesos, los pedidos de Southridge Video el **OrderManager** orquestación, procesa pedidos.</span><span class="sxs-lookup"><span data-stu-id="260b7-103">This section describes how the Southridge Video order process manager, the **OrderManager** orchestration, processes orders.</span></span> <span data-ttu-id="260b7-104">Esta sección sigue un pedido nuevo a través de la orquestación.</span><span class="sxs-lookup"><span data-stu-id="260b7-104">This section follows a new order through the orchestration.</span></span> <span data-ttu-id="260b7-105">Además, aborda cómo controla la orquestación las actualizaciones de los pedidos.</span><span class="sxs-lookup"><span data-stu-id="260b7-105">The section also discusses how the orchestration handles updates to orders.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="260b7-106">La solución de administrador de procesos empresariales incluye sólo un administrador de procesos, pese a que esté diseñado para utilizar más de un tipo.</span><span class="sxs-lookup"><span data-stu-id="260b7-106">The business process manager solution includes only one process manager although it is written so that it can use more than one type of manager.</span></span>  
  
 <span data-ttu-id="260b7-107">El **OrderManager** orquestación coordina orquestaciones subordinadas que implementan el proceso empresarial para controlar el orden.</span><span class="sxs-lookup"><span data-stu-id="260b7-107">The **OrderManager** orchestration coordinates subordinate orchestrations that implement the business process to handle the order.</span></span> <span data-ttu-id="260b7-108">El **OrderManager** envía el pedido a través de dos fases que, combinados, validar el pedido, la información de envío para el grupo de instalaciones, enviar el pedido al sistema de pedidos a través de los componentes de comunicación remota y actualizar el historial de pedidos.</span><span class="sxs-lookup"><span data-stu-id="260b7-108">The **OrderManager** sends the order through two stages which, combined, validate the order, send the information to the facilities group, send the order to the order system through remoting components, and update the order history.</span></span> <span data-ttu-id="260b7-109">Puede agregar, eliminar o modificar estas fases sin tener que cambiar la **OrderManager**.</span><span class="sxs-lookup"><span data-stu-id="260b7-109">You can add, delete, or modify these stages without having to change the **OrderManager**.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="260b7-110">Debido al tamaño y el ámbito de la **OrderManager** orquestación, puede que desee leer esta sección con la orquestación abierta en Microsoft Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="260b7-110">Because of the size and scope of the **OrderManager** orchestration, you may want to read this section with the orchestration open in Microsoft Visual Studio.</span></span>  
  
## <a name="order-manager-structure"></a><span data-ttu-id="260b7-111">Estructura del administrador de pedidos</span><span class="sxs-lookup"><span data-stu-id="260b7-111">Order Manager Structure</span></span>  
 <span data-ttu-id="260b7-112">El **OrderManager** orquestación comienza con una forma recepción que activa la orquestación.</span><span class="sxs-lookup"><span data-stu-id="260b7-112">The **OrderManager** orchestration begins with a receive shape that activates the orchestration.</span></span> <span data-ttu-id="260b7-113">El siguiente diagrama muestra la estructura general de la **OrderManager** orquestación.</span><span class="sxs-lookup"><span data-stu-id="260b7-113">The following diagram shows the general structure of the **OrderManager** orchestration.</span></span>  
  
 <span data-ttu-id="260b7-114">![Diagrama del Administrador de pedidos en bloques](../core/media/ordermanagerblockdiagram.gif "OrderManagerBlockDiagram")</span><span class="sxs-lookup"><span data-stu-id="260b7-114">![Block Diagram of Order Manager](../core/media/ordermanagerblockdiagram.gif "OrderManagerBlockDiagram")</span></span>  
  
 <span data-ttu-id="260b7-115">La primera forma de recepción conduce a dos ramas principales.</span><span class="sxs-lookup"><span data-stu-id="260b7-115">The first receive shape leads to two main branches.</span></span> <span data-ttu-id="260b7-116">Una rama, la derecha, procesa pedidos nuevos.</span><span class="sxs-lookup"><span data-stu-id="260b7-116">One branch, the right one, processes new orders.</span></span> <span data-ttu-id="260b7-117">La rama izquierda, por su parte, controla las cancelaciones de pedido.</span><span class="sxs-lookup"><span data-stu-id="260b7-117">The left branch, handles order cancellations.</span></span> <span data-ttu-id="260b7-118">Dado que acepta la entrada de usuario, es posible que el **OrderManager** para recibir una cancelación de pedido después de que un pedido ya se ha completado.</span><span class="sxs-lookup"><span data-stu-id="260b7-118">Because it accepts user input, it is possible for the **OrderManager** to receive an order cancellation after an order has already completed.</span></span> <span data-ttu-id="260b7-119">Éste es el caso que controla la rama principal izquierda.</span><span class="sxs-lookup"><span data-stu-id="260b7-119">This is the case the left main branch handles.</span></span> <span data-ttu-id="260b7-120">La rama controla la cancelación aislada y, para ello, establece indicadores de finalización de procesamientos y agrega advertencias a los registros de sucesos.</span><span class="sxs-lookup"><span data-stu-id="260b7-120">The branch handles the isolated cancellation by setting flags for terminating processing and by adding a warning to the event log.</span></span> <span data-ttu-id="260b7-121">La orquestación controla las cancelaciones de pedido que recibe mientras se procesa un pedido en la rama derecha.</span><span class="sxs-lookup"><span data-stu-id="260b7-121">The orchestration handles order cancellations that arrive while an order is being processed inside the right-hand branch.</span></span>  
  
 <span data-ttu-id="260b7-122">La rama de procesamiento de pedidos realiza algunas operaciones de inicialización y especifica dos bucles anidados.</span><span class="sxs-lookup"><span data-stu-id="260b7-122">The order processing branch does some initialization and then enters two nested loops.</span></span> <span data-ttu-id="260b7-123">El bucle externo se ejecuta una vez en cada fase de procesamiento del pedido.</span><span class="sxs-lookup"><span data-stu-id="260b7-123">The outer loop runs once for each stage in the order processing.</span></span> <span data-ttu-id="260b7-124">El bucle interno se ejecuta durante el procesamiento de la fase.</span><span class="sxs-lookup"><span data-stu-id="260b7-124">The inner loop runs while the stage is processing.</span></span> <span data-ttu-id="260b7-125">Además, el administrador de pedidos escucha las posibles actualizaciones del pedido dentro del bucle interno.</span><span class="sxs-lookup"><span data-stu-id="260b7-125">The order manager also listens for possible updates to the order inside the inner loop.</span></span> <span data-ttu-id="260b7-126">Una vez que terminan los bucles, el administrador de pedidos envía un mensaje de finalización.</span><span class="sxs-lookup"><span data-stu-id="260b7-126">After the loops terminate, the order manager sends a completion message.</span></span>  
  
 <span data-ttu-id="260b7-127">Las fases de procesamiento de pedidos usan puertos dinámicos, autocorrelación para comunicarse de vuelta con el **OrderManager** orquestación.</span><span class="sxs-lookup"><span data-stu-id="260b7-127">The order processing stages use dynamic, self-correlating ports to communicate back to the **OrderManager** orchestration.</span></span> <span data-ttu-id="260b7-128">Esto simplifica la correlación de la **OrderManager** con la fase de instancias ya que evita la necesidad de usar un conjunto de correlaciones.</span><span class="sxs-lookup"><span data-stu-id="260b7-128">This simplifies correlation of the **OrderManager** with the stage instances because it eliminates the need to use a correlation set.</span></span> <span data-ttu-id="260b7-129">Para obtener más información acerca de los puertos de autocorrelación, consulte [enlaces de puerto](../core/port-bindings.md).</span><span class="sxs-lookup"><span data-stu-id="260b7-129">For more information about self-correlating ports, see [Port Bindings](../core/port-bindings.md).</span></span>  
  
## <a name="receiving-orders"></a><span data-ttu-id="260b7-130">Recibir pedidos</span><span class="sxs-lookup"><span data-stu-id="260b7-130">Receiving Orders</span></span>  
 <span data-ttu-id="260b7-131">El **OrderManager** recibe mensajes de pedidos de la **OrderBroker** orquestación a través de la **FromBrokerPort** puerto.</span><span class="sxs-lookup"><span data-stu-id="260b7-131">The **OrderManager** receives order messages from the **OrderBroker** orchestration through the **FromBrokerPort** port.</span></span> <span data-ttu-id="260b7-132">Este puerto está vinculado directamente a la base de datos de cuadro de mensajes.</span><span class="sxs-lookup"><span data-stu-id="260b7-132">This port is bound directly to the MessageBox database.</span></span> <span data-ttu-id="260b7-133">La orquestación tiene dos **recepción** formas se conectan al puerto: uno para los pedidos nuevos y otro para actualizan los pedidos.</span><span class="sxs-lookup"><span data-stu-id="260b7-133">The orchestration has two **Receive** shapes connected to the port: one for new orders and one for updated orders.</span></span>  
  
 <span data-ttu-id="260b7-134">El **OrderManger** determina qué mensajes se proceso basado en una expresión de filtro.</span><span class="sxs-lookup"><span data-stu-id="260b7-134">The **OrderManger** determines which messages to process based on a filter expression.</span></span> <span data-ttu-id="260b7-135">La expresión de filtro prueba el valor del campo de estado de mensaje y el campo de tipo de administrador de pedidos, **OrderMgrType**.</span><span class="sxs-lookup"><span data-stu-id="260b7-135">The filter expression tests the value in the message status field and the order manager type field, **OrderMgrType**.</span></span> <span data-ttu-id="260b7-136">Si el campo de estado es igual a ACCEPTED y el **OrderMgrType** está establecido en CABLEORDER, el orden es nuevo y está diseñado para este administrador de procesos.</span><span class="sxs-lookup"><span data-stu-id="260b7-136">If the status field is equal to ACCEPTED, and the **OrderMgrType** is CABLEORDER, the order is new and intended for this process manager.</span></span>  
  
 <span data-ttu-id="260b7-137">El pedido nuevo activa una instancia nueva de la orquestación.</span><span class="sxs-lookup"><span data-stu-id="260b7-137">The new order activates a new instance of the orchestration.</span></span> <span data-ttu-id="260b7-138">El **OrderManager** vuelva a comprobar el tipo de la solicitud en un **decisión** forma.</span><span class="sxs-lookup"><span data-stu-id="260b7-138">The **OrderManager** next checks the type of the request in a **Decision** shape.</span></span> <span data-ttu-id="260b7-139">Si el tipo es Finalizar, la orquestación ejecuta la rama izquierda y finaliza el pedido.</span><span class="sxs-lookup"><span data-stu-id="260b7-139">If the type is Terminate, the orchestration executes the left-hand branch and terminates the order.</span></span> <span data-ttu-id="260b7-140">De lo contrario, la orquestación continúa procesando el pedido.</span><span class="sxs-lookup"><span data-stu-id="260b7-140">Otherwise, the orchestration proceeds with processing the order.</span></span> <span data-ttu-id="260b7-141">Observe que aquí se incluye la escucha de los mensajes posteriores que estén relacionados con este pedido en concreto.</span><span class="sxs-lookup"><span data-stu-id="260b7-141">Notice that this includes listening for subsequent messages related to this particular order.</span></span>  
  
## <a name="initialization-for-new-orders"></a><span data-ttu-id="260b7-142">Inicialización de pedidos nuevos</span><span class="sxs-lookup"><span data-stu-id="260b7-142">Initialization for New Orders</span></span>  
 <span data-ttu-id="260b7-143">Después de la **OrderManager** orquestación recibe un mensaje inicial y comienza la bifurcación main derecha, obtiene su información de configuración de la **SSOConfigStore**.</span><span class="sxs-lookup"><span data-stu-id="260b7-143">After the **OrderManager** orchestration receives an initial message and begins the main right-hand branch, it gets its configuration information from the **SSOConfigStore**.</span></span> <span data-ttu-id="260b7-144">Esto lo hace a través de un objeto singleton, definido en el **utilidades** ensamblado.</span><span class="sxs-lookup"><span data-stu-id="260b7-144">It does this through a singleton object defined in the **Utilities** assembly.</span></span> <span data-ttu-id="260b7-145">Los valores de configuración son propiedades del objeto.</span><span class="sxs-lookup"><span data-stu-id="260b7-145">The configuration values are properties of the object.</span></span> <span data-ttu-id="260b7-146">El objeto administra una caché local de los valores de configuración parecida a la solución de arquitectura orientada a servicios.</span><span class="sxs-lookup"><span data-stu-id="260b7-146">The object manages a local cache of the configuration values similar to the Service Oriented Architecture solution.</span></span> <span data-ttu-id="260b7-147">Para obtener más información sobre el objeto singleton, vea [usar SSO de forma eficaz en la solución de administración de procesos empresariales](../core/using-sso-efficiently-in-the-business-process-management-solution.md).</span><span class="sxs-lookup"><span data-stu-id="260b7-147">For more information about the singleton object, see [Using SSO Efficiently in the Business Process Management Solution](../core/using-sso-efficiently-in-the-business-process-management-solution.md).</span></span>  
  
 <span data-ttu-id="260b7-148">Al igual que ocurre con la solución orientada a servicios, la solución de administración de procesos empresariales utiliza el almacén de secreto (puesto que aparece siempre que BizTalk está instalado) y SSO almacena en caché la información de configuración para que todos los valores estén disponibles con facilidad; además, puede proteger información como, por ejemplo, cadenas y contraseñas de conexión de bases de datos.</span><span class="sxs-lookup"><span data-stu-id="260b7-148">Like the Service Oriented solution, the Business Process Management solution uses the secret store because it is present whenever BizTalk is installed, SSO caches the configuration information so that the values are readily available, and it can protect information such as database connection strings and passwords.</span></span> <span data-ttu-id="260b7-149">Por todo ello, el almacén secreto se convierte en la ubicación idónea para la información de configuración, aunque no se esté utilizando el inicio de sesión único para administrar las conexiones a las aplicaciones de servidor.</span><span class="sxs-lookup"><span data-stu-id="260b7-149">For all of these reasons, the secret store would be a good place for the configuration information even if Single Sign-On weren't being used for managing connections to the backend applications.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="260b7-150">La orquestación recupera información de configuración antes de iniciar el procesamiento.</span><span class="sxs-lookup"><span data-stu-id="260b7-150">The orchestration retrieves configuration information before starting processing.</span></span> <span data-ttu-id="260b7-151">De esta manera, se garantiza que la orquestación utilice la misma configuración en caso de que se deshidrate y recupere la hidratación.</span><span class="sxs-lookup"><span data-stu-id="260b7-151">This ensures the orchestration uses the same configuration if it is dehydrated and, later, rehydrated.</span></span> <span data-ttu-id="260b7-152">Para obtener más información acerca de la deshidratación, vea [orquestación deshidratación y rehidratación](../core/orchestration-dehydration-and-rehydration.md).</span><span class="sxs-lookup"><span data-stu-id="260b7-152">For more information about dehydration, see [Orchestration Dehydration and Rehydration](../core/orchestration-dehydration-and-rehydration.md).</span></span>  
  
 <span data-ttu-id="260b7-153">El Administrador de pedidos utiliza un valor de los datos de configuración: **TotalStages**, el número total de fases en el proceso de administración de pedidos.</span><span class="sxs-lookup"><span data-stu-id="260b7-153">The order manager uses one value from the configuration data: **TotalStages**, the total number of stages in the order handling process.</span></span> <span data-ttu-id="260b7-154">El administrador asigna este valor a una variable local, **numStages**.</span><span class="sxs-lookup"><span data-stu-id="260b7-154">The manager assigns this value to a local variable, **numStages**.</span></span> <span data-ttu-id="260b7-155">También establece dos variables más conectadas al bucle externo, **fase** y **detener**.</span><span class="sxs-lookup"><span data-stu-id="260b7-155">It also sets two more variables connected to the outer loop, **stage** and **stop**.</span></span> <span data-ttu-id="260b7-156">El **fase** indica la fase actual y representa el contador del bucle externo; **detener** el valor de detención.</span><span class="sxs-lookup"><span data-stu-id="260b7-156">The **stage** indicates the current stage and is the counter for the outer loop; **stop** the stopping value.</span></span>  
  
 <span data-ttu-id="260b7-157">Por último, el administrador establece la **orderStatus** variable Started y especifica el bucle de procesamiento externo.</span><span class="sxs-lookup"><span data-stu-id="260b7-157">Finally, the manager sets the **orderStatus** variable to STARTED and enters the outer processing loop.</span></span>  
  
## <a name="new-order-processing-loops"></a><span data-ttu-id="260b7-158">Nuevos bucles de procesamiento de pedidos</span><span class="sxs-lookup"><span data-stu-id="260b7-158">New Order Processing Loops</span></span>  
 <span data-ttu-id="260b7-159">El bucle externo se ejecuta siempre que el valor de la **fase** variable es menor que el valor de la **numStages** variable.</span><span class="sxs-lookup"><span data-stu-id="260b7-159">The outer loop runs as long as the value of the **stage** variable is less than the value of the **numStages** variable.</span></span> <span data-ttu-id="260b7-160">Los bucles externos dirigen el procesamiento de cada fase.</span><span class="sxs-lookup"><span data-stu-id="260b7-160">The outer loops drives the processing for each stage.</span></span> <span data-ttu-id="260b7-161">El bucle interno se ejecuta siempre que se esté procesando una fase.</span><span class="sxs-lookup"><span data-stu-id="260b7-161">The inner loop runs so long as a stage is still being processed.</span></span> <span data-ttu-id="260b7-162">También escucha los cambios posibles del pedido.</span><span class="sxs-lookup"><span data-stu-id="260b7-162">It also listens for possible changes to the order.</span></span>  
  
### <a name="outer-loop"></a><span data-ttu-id="260b7-163">Bucle externo</span><span class="sxs-lookup"><span data-stu-id="260b7-163">Outer Loop</span></span>  
 <span data-ttu-id="260b7-164">La orquestación inicia el bucle externo mediante la asignación del mensaje recibido (**NewOrderMgrMsg**) a una variable, **OrderMgrMsg**.</span><span class="sxs-lookup"><span data-stu-id="260b7-164">The orchestration begins the outer loop by assigning the received message (**NewOrderMgrMsg**) to a variable, **OrderMgrMsg**.</span></span> <span data-ttu-id="260b7-165">A continuación, copia la fase y el estado a la parte de enrutamiento del mensaje.</span><span class="sxs-lookup"><span data-stu-id="260b7-165">It then copies the stage and status to the routing part of the message.</span></span> <span data-ttu-id="260b7-166">La orquestación también establece la dirección del remitente en el mensaje a la dirección de la **StageCompletionPort**:</span><span class="sxs-lookup"><span data-stu-id="260b7-166">The orchestration also sets the return address in the message to the address of the **StageCompletionPort**:</span></span>  
  
```  
OrderMgrMsg.RoutingPart.OrderMgrReturnAddress =   
       StageCompletionPort(Microsoft.XLANGs.BaseTypes.Address);  
```  
  
 <span data-ttu-id="260b7-167">La orquestación, a continuación, envía el pedido a la **StagePort**, un puerto de petición-respuesta.</span><span class="sxs-lookup"><span data-stu-id="260b7-167">The orchestration then sends the order to the **StagePort**, a solicit-response port.</span></span> <span data-ttu-id="260b7-168">La orquestación espera la confirmación de la fase que ha iniciado el procesamiento del pedido.</span><span class="sxs-lookup"><span data-stu-id="260b7-168">The orchestration then waits for an acknowledgement from the stage that order processing has started.</span></span> <span data-ttu-id="260b7-169">La fase envía un **OrderAck** cuando se inicia el orden de procesamiento de mensajes.</span><span class="sxs-lookup"><span data-stu-id="260b7-169">The stage sends an **OrderAck** message when it starts processing the order.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="260b7-170">El **OrderAck** mensaje es uno de varios en la solución definida por las clases. NET, en lugar de un esquema.</span><span class="sxs-lookup"><span data-stu-id="260b7-170">The **OrderAck** message is one of several in the solution defined by .NET classes rather than a schema.</span></span> <span data-ttu-id="260b7-171">Para obtener más información sobre cómo usar las clases de .NET para definir mensajes, vea [construir mensajes en el código de usuario](../core/constructing-messages-in-user-code.md).</span><span class="sxs-lookup"><span data-stu-id="260b7-171">For more information about using .NET classes to define messages, see [Constructing Messages in User Code](../core/constructing-messages-in-user-code.md).</span></span>  
  
 <span data-ttu-id="260b7-172">Cuando la orquestación recibe la confirmación, asigna la fase a la **currentStage** variable y entra en el bucle interno.</span><span class="sxs-lookup"><span data-stu-id="260b7-172">When the orchestration receives the acknowledgement, it assigns the stage to the **currentStage** variable and enters the inner loop.</span></span>  
  
### <a name="inner-loop"></a><span data-ttu-id="260b7-173">Bucle interno</span><span class="sxs-lookup"><span data-stu-id="260b7-173">Inner Loop</span></span>  
 <span data-ttu-id="260b7-174">El bucle interno se ejecuta siempre que el **currentStage** variable es igual a la **fase** variable; que sea, siempre que se está procesando la fase actual.</span><span class="sxs-lookup"><span data-stu-id="260b7-174">The inner loop runs as long as the **currentStage** variable is equal to the **stage** variable; that is, as long as the current stage is being processed.</span></span> <span data-ttu-id="260b7-175">El cuerpo del bucle es un **escuchar** forma con tres **recepción** formas.</span><span class="sxs-lookup"><span data-stu-id="260b7-175">The body of the loop is a **Listen** shape with three **Receive** shapes.</span></span> <span data-ttu-id="260b7-176">La forma situada en la orquestación, **solicitud de pedido**, forma parte del mecanismo de actualización de orden, se describe en la sección siguiente.</span><span class="sxs-lookup"><span data-stu-id="260b7-176">The leftmost shape in the orchestration, **Order Request**, is part of the order update mechanism, described in the next section.</span></span>  
  
 <span data-ttu-id="260b7-177">Cuando un pedido finaliza la fase de procesamiento, envía un mensaje a la **StageCompletion** puerto de la **OrderManager** orquestación.</span><span class="sxs-lookup"><span data-stu-id="260b7-177">When an order processing stage finishes, it sends a message to the **StageCompletion** port of the **OrderManager** orchestration.</span></span> <span data-ttu-id="260b7-178">Si la fase finaliza de forma repentina debido a un error, envía una **TerminatedMessage**.</span><span class="sxs-lookup"><span data-stu-id="260b7-178">If the stage abruptly terminates due to an error, it sends a **TerminatedMessage**.</span></span> <span data-ttu-id="260b7-179">En este caso, el **OrderManager** produce una excepción.</span><span class="sxs-lookup"><span data-stu-id="260b7-179">In this case, the **OrderManager** throws an exception.</span></span> <span data-ttu-id="260b7-180">El controlador de excepciones exterior detecta la excepción y envía un mensaje de error para la **OperatorPort**.</span><span class="sxs-lookup"><span data-stu-id="260b7-180">The outermost exception handler catches the exception and sends an error message to the **OperatorPort**.</span></span>  
  
 <span data-ttu-id="260b7-181">Si la fase envía un **OrderMgrMsg**, **OrderManager** incrementos la **fase** variable.</span><span class="sxs-lookup"><span data-stu-id="260b7-181">If the stage sends an **OrderMgrMsg**, the **OrderManager** increments the **stage** variable.</span></span> <span data-ttu-id="260b7-182">Si existen más fases (fase menor o igual a numStages), la orquestación establece el estado del pedido **OrderMgrMsg** como stage_n_completed, donde n es el número de la fase actual.</span><span class="sxs-lookup"><span data-stu-id="260b7-182">If there are more stages (stage less than or equal to numStages), the orchestrations sets the order status in **OrderMgrMsg** to STAGE_n_COMPLETED where n is the number of the current stage.</span></span> <span data-ttu-id="260b7-183">Si no hubiera más fases, establece el estado del pedido como COMPLETED y sale de los bucles.</span><span class="sxs-lookup"><span data-stu-id="260b7-183">If there are no more stages, it sets the order status to COMPLETED and exits both loops.</span></span>  
  
## <a name="order-updates"></a><span data-ttu-id="260b7-184">Actualizaciones de pedido</span><span class="sxs-lookup"><span data-stu-id="260b7-184">Order Updates</span></span>  
 <span data-ttu-id="260b7-185">El **OrderManager** orquestación escucha las actualizaciones de pedido dentro del bucle de procesamiento interno.</span><span class="sxs-lookup"><span data-stu-id="260b7-185">The **OrderManager** orchestration listens for order updates inside the inner processing loop.</span></span> <span data-ttu-id="260b7-186">Tenga en cuenta que la **recepción** forma utiliza para ello, **OrderRequest**, también se utiliza la **FromBrokerPort**.</span><span class="sxs-lookup"><span data-stu-id="260b7-186">Notice that the **Receive** shape it uses for this, **OrderRequest**, also uses the **FromBrokerPort**.</span></span> <span data-ttu-id="260b7-187">El empleo de una segunda forma de recepción en el mismo puerto de un bucle, junto con los conjuntos de correlaciones, constituyen un patrón habitual de BizTalk Server, el patrón de convoy.</span><span class="sxs-lookup"><span data-stu-id="260b7-187">The use of a second receive shape on the same port inside a loop, combined with correlation sets, forms a common BizTalk Server pattern, the convoy pattern.</span></span> <span data-ttu-id="260b7-188">El patrón de convoy se utiliza para garantizar que la misma instancia de una orquestación procesa todos los mensajes conectados con una operación determinada.</span><span class="sxs-lookup"><span data-stu-id="260b7-188">You use the convoy pattern to ensure that the same instance of an orchestration processes the first and subsequent messages connected with a particular operation.</span></span>  
  
 <span data-ttu-id="260b7-189">Cuando el administrador de pedidos recibe el primer mensaje conectado a un pedido, inicializa dos conjuntos de correlaciones.</span><span class="sxs-lookup"><span data-stu-id="260b7-189">When the order manager receives the first message connected to an order, it initializes two correlation sets.</span></span> <span data-ttu-id="260b7-190">La primera, **OrderCorrelation**, usa el identificador de cliente (**CustID**) y el Id. de pedido (**OrderID**).</span><span class="sxs-lookup"><span data-stu-id="260b7-190">The first, **OrderCorrelation**, uses the customer ID (**CustID**) and order ID (**OrderID**).</span></span> <span data-ttu-id="260b7-191">El administrador de pedidos utiliza esta correlación con las fases de procesamiento de pedidos.</span><span class="sxs-lookup"><span data-stu-id="260b7-191">The order manager shares this correlation with the order processing stages.</span></span> <span data-ttu-id="260b7-192">La correlación de la segunda es la correlación de convoy, **OrderConvoyCorrelation**, que utiliza el estado del pedido (**estado**) además de los Id. de cliente y el ID de pedido.</span><span class="sxs-lookup"><span data-stu-id="260b7-192">The second correlation is the convoy correlation, **OrderConvoyCorrelation**, which uses the order status (**Status**) in addition to the customer ID and order ID.</span></span> <span data-ttu-id="260b7-193">El **OrderRequestReceive** forma usa **OrderConvoyCorrelation** como un conjunto de correlaciones siguientes.</span><span class="sxs-lookup"><span data-stu-id="260b7-193">The **OrderRequestReceive** shape uses **OrderConvoyCorrelation** as a Following Correlation Set.</span></span> <span data-ttu-id="260b7-194">Esta configuración de la correlación garantiza que la instancia del administrador de pedidos reciba cambios para el pedido que está procesando.</span><span class="sxs-lookup"><span data-stu-id="260b7-194">Setting the correlation set up this way ensures that the instance of the order manager working on a particular order receives any changes.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="260b7-195">Recuerde que un conjunto de correlaciones es una agrupación de propiedades de mensaje utilizadas para determinar si un mensaje pertenece a una instancia determinada de una orquestación.</span><span class="sxs-lookup"><span data-stu-id="260b7-195">Recall that a correlation set is a grouping of message properties used to determine whether or not a message belongs to a given instance of an orchestration.</span></span> <span data-ttu-id="260b7-196">Para obtener más información, consulte [usar correlaciones en orquestaciones](../core/using-correlations-in-orchestrations.md).</span><span class="sxs-lookup"><span data-stu-id="260b7-196">For more information, see [Using Correlations in Orchestrations](../core/using-correlations-in-orchestrations.md).</span></span>  
  
 <span data-ttu-id="260b7-197">Cuando el **OrderManager** recibe un mensaje posterior para un pedido, en primer lugar comprueba el tipo de solicitud.</span><span class="sxs-lookup"><span data-stu-id="260b7-197">When the **OrderManager** receives a subsequent message for an order, it first tests the type of request.</span></span> <span data-ttu-id="260b7-198">Si TERMINATE es el tipo de solicitud, la forma Decisión ejecuta la rama de finalización.</span><span class="sxs-lookup"><span data-stu-id="260b7-198">If the request type is TERMINATE, the Decision shape executes the terminate branch.</span></span> <span data-ttu-id="260b7-199">De lo contrario, la orquestación realiza una prueba en el mensaje nuevo para ver si se trata de una actualización.</span><span class="sxs-lookup"><span data-stu-id="260b7-199">Otherwise, the orchestration tests the new message to see if it is an update.</span></span> <span data-ttu-id="260b7-200">Un mensaje de actualización tiene un número de secuencia superior (**SeqNum**) a la solicitud original.</span><span class="sxs-lookup"><span data-stu-id="260b7-200">An update message has a higher sequence number (**SeqNum**) than the original request.</span></span> <span data-ttu-id="260b7-201">Si el número de secuencia del mensaje nuevo es superior, la orquestación comienza el procesamiento del pedido con el mensaje nuevo.</span><span class="sxs-lookup"><span data-stu-id="260b7-201">If the new message's sequence number is higher, the orchestration starts the order processing over with the new message.</span></span> <span data-ttu-id="260b7-202">Si el mensaje de actualización y el original cuentan con el mismo número de secuencia o el número de secuencia del mensaje de actualización es inferior, existe un error de secuencia.</span><span class="sxs-lookup"><span data-stu-id="260b7-202">If the original and update message have the same or a lower sequence number, there is a sequence error.</span></span> <span data-ttu-id="260b7-203">Si los números de secuencia coinciden, el pedido está duplicado y se marca como un error de duplicado.</span><span class="sxs-lookup"><span data-stu-id="260b7-203">If the sequence numbers are equal, it is a duplicate order and flagged as a duplicate error.</span></span>  
  
 <span data-ttu-id="260b7-204">Para obtener más información acerca de **SeqNum**, consulte [clave mensajes y campos](../core/key-messages-and-fields.md).</span><span class="sxs-lookup"><span data-stu-id="260b7-204">For more information about **SeqNum**, see [Key Messages and Fields](../core/key-messages-and-fields.md).</span></span>  
  
## <a name="final-steps"></a><span data-ttu-id="260b7-205">Pasos finales</span><span class="sxs-lookup"><span data-stu-id="260b7-205">Final Steps</span></span>  
 <span data-ttu-id="260b7-206">Después de salir de los bucles, el Administrador de pedidos asigna la dirección de respuesta para el puerto dinámico **CSRCompletionPort**.</span><span class="sxs-lookup"><span data-stu-id="260b7-206">After exiting the loops, the order manager assigns the reply address to the dynamic port **CSRCompletionPort**.</span></span> <span data-ttu-id="260b7-207">Seguidamente, el administrador construye el mensaje de estado de finalización, lo envía y prueba si se ha producido un error.</span><span class="sxs-lookup"><span data-stu-id="260b7-207">The manager then constructs the completion status message, sends it, and then tests if there was an error.</span></span> <span data-ttu-id="260b7-208">En caso de que exista un error, la orquestación ejecuta una forma Finalizar; de lo contrario, simplemente termina.</span><span class="sxs-lookup"><span data-stu-id="260b7-208">If there was an error, the orchestration exectues a Terminate shape; otherwise, it simply ends.</span></span>  
  
## <a name="coordinating-with-the-stages"></a><span data-ttu-id="260b7-209">Coordinar con las fases</span><span class="sxs-lookup"><span data-stu-id="260b7-209">Coordinating with the Stages</span></span>  
 <span data-ttu-id="260b7-210">Tanto el **OrderBroker** orquestación y la segunda orquestación de la fase de procesamiento (**CableOrder2**) crea entradas en la base de datos de historial.</span><span class="sxs-lookup"><span data-stu-id="260b7-210">Both the **OrderBroker** orchestration and the second processing stage orchestration (**CableOrder2**) make entries in the history database.</span></span> <span data-ttu-id="260b7-211">La orquestación CableOrder2 actualiza la información de historial especificada por el **OrderBroker** orquestación.</span><span class="sxs-lookup"><span data-stu-id="260b7-211">The CableOrder2 orchestration updates the history information entered by the **OrderBroker** orchestration.</span></span> <span data-ttu-id="260b7-212">Para asegurarse de que hay una entrada en la base de datos para actualizar, el **OrderBroker** utiliza la notificación de entrega en el puerto que utiliza la base de datos.</span><span class="sxs-lookup"><span data-stu-id="260b7-212">In order to ensure there is an entry in the database to update, the **OrderBroker** uses delivery notification on the port it uses for the database.</span></span>  
  
 <span data-ttu-id="260b7-213">Configuración asigna el **OrderBroker** puerto de envío para la base de datos de historial para un grupo de puertos de envío que contiene dos puertos: un puerto para la configuración de pruebas (**HistoryInsert-Test-SP**), uno para regular configuración (**HistoryInsert-SP**).</span><span class="sxs-lookup"><span data-stu-id="260b7-213">Configuration maps the **OrderBroker** send port for the history database to a send port group containing two ports—one port for the test configuration (**HistoryInsert-Test-SP**), one for the regular configuration (**HistoryInsert-SP**).</span></span> <span data-ttu-id="260b7-214">Si mantiene los dos puertos del grupo activos, la solución envía mensajes en ambos puertos.</span><span class="sxs-lookup"><span data-stu-id="260b7-214">If you leave both ports in the group active, the solution sends messages on both ports.</span></span> <span data-ttu-id="260b7-215">Por consiguiente, solicita dos notificaciones de entrega, pero solamente procesa una.</span><span class="sxs-lookup"><span data-stu-id="260b7-215">It thus requests two delivery notifications but processes only one.</span></span>  
  
 <span data-ttu-id="260b7-216">Para evitar esta situación, dar de baja el puerto de prueba (**HistoryInsert-Test-SP**), o detener la versión de prueba de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="260b7-216">To avoid this situation, unenlist the test port (**HistoryInsert-Test-SP**), or stop the test version of the application.</span></span> <span data-ttu-id="260b7-217">Para obtener más información acerca de la notificación de entrega, vea [confirmaciones utilizando](../core/using-acknowledgments.md).</span><span class="sxs-lookup"><span data-stu-id="260b7-217">For more information about delivery notification, see [Using Acknowledgments](../core/using-acknowledgments.md).</span></span>  
  
## <a name="errors-and-routing-repaired-messagesdesign-choices"></a><span data-ttu-id="260b7-218">Errores y el enrutamiento de mensajes reparados: opciones de diseño</span><span class="sxs-lookup"><span data-stu-id="260b7-218">Errors and Routing Repaired Messages—Design Choices</span></span>  
 <span data-ttu-id="260b7-219">La orquestación de controlador de excepción y las orquestaciones utilizadas por las fases de procesamiento de pedido utilizan una orquestación de control de errores (**ErrorHandlerOrch**) para enrutar los pedidos defectuosos para su reparación.</span><span class="sxs-lookup"><span data-stu-id="260b7-219">The exception handler orchestration and orchestrations used by the order processing stages use an error handling orchestration (**ErrorHandlerOrch**) to route bad orders for repair.</span></span> <span data-ttu-id="260b7-220">El diseño supone que existe un departamento o grupo que arreglará los errores del pedido como sea necesario.</span><span class="sxs-lookup"><span data-stu-id="260b7-220">The design supposes that there is a department or group that will fix the order in the form needed.</span></span> <span data-ttu-id="260b7-221">El pedido reparado no vuelve a enviarse a través de la orquestación orderbroker (**OrderBroker**).</span><span class="sxs-lookup"><span data-stu-id="260b7-221">The repaired order is not resubmitted through the order broker orchestration (**OrderBroker**).</span></span> <span data-ttu-id="260b7-222">En su lugar, el pedido normalizado se repara en la forma normalizada.</span><span class="sxs-lookup"><span data-stu-id="260b7-222">Rather, the normalized order is repaired in its normalized form.</span></span> <span data-ttu-id="260b7-223">En el diseño actual de la solución, la orquestación de controlador enruta el mensaje de error al origen del pedido original.</span><span class="sxs-lookup"><span data-stu-id="260b7-223">The current design of the solution has the handler orchestration route the error message back to the source of the original order.</span></span> <span data-ttu-id="260b7-224">Sin embargo, los pedidos reparados deben enrutarse a un puerto MSMQ en la orquestación de control de errores.</span><span class="sxs-lookup"><span data-stu-id="260b7-224">Repaired orders, however, have to be routed to an MSMQ port on the error handler orchestration.</span></span> <span data-ttu-id="260b7-225">(La versión de prueba de la solución utiliza una carpeta de archivos.) El control de errores devuelve el mensaje reparado a una orquestación de llamada.</span><span class="sxs-lookup"><span data-stu-id="260b7-225">(The test version of the solution uses a file folder.) The error handler then returns the repaired message to the calling orchestration.</span></span>  
  
 <span data-ttu-id="260b7-226">Esta solución utiliza este diseño, pues el agente de pedido realiza una normalización y validación significativa del mensaje de pedido.</span><span class="sxs-lookup"><span data-stu-id="260b7-226">This solution uses this design, because the order broker does significant validation and normalization of the order message.</span></span> <span data-ttu-id="260b7-227">A su vez, el mensaje de pedido que necesita reparación también se encuentra en la forma normalizada.</span><span class="sxs-lookup"><span data-stu-id="260b7-227">In turn, the order message requiring repair is also in the normalized form.</span></span> <span data-ttu-id="260b7-228">El mantenimiento de la forma normalizada del mensaje impide tener que tratar la diferencia existente entre las formas enviada y normalizada de los mensajes.</span><span class="sxs-lookup"><span data-stu-id="260b7-228">Maintaining the normalized form of the message prevents having to work around the difference between the submitted and normalized forms of the messages.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="260b7-229">Vea también</span><span class="sxs-lookup"><span data-stu-id="260b7-229">See Also</span></span>  
 <span data-ttu-id="260b7-230">[Lógica del Administrador de procesos](../core/process-manager-logic.md) </span><span class="sxs-lookup"><span data-stu-id="260b7-230">[Process Manager Logic](../core/process-manager-logic.md) </span></span>  
 [<span data-ttu-id="260b7-231">Campos y los mensajes de teclado</span><span class="sxs-lookup"><span data-stu-id="260b7-231">Key Messages and Fields</span></span>](../core/key-messages-and-fields.md)