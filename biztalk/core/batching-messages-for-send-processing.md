---
title: Procesamiento de envío de mensajes por lotes para | Microsoft Docs
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: 7d9115ec-13bc-41a8-8928-57b168c95af4
caps.latest.revision: 6
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 7854151b0b32165d2ec3db83a90516898cf8d8e6
ms.sourcegitcommit: 53b16fe6c1b1707ecf233dbd05f780653eb19419
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 11/01/2018
ms.locfileid: "50753140"
---
# <a name="batching-messages-for-send-processing"></a><span data-ttu-id="4d8c4-102">Procesar mensajes por lotes para el procesamiento de envío</span><span class="sxs-lookup"><span data-stu-id="4d8c4-102">Batching Messages for Send Processing</span></span>
## <a name="send-adapter-batch-management"></a><span data-ttu-id="4d8c4-103">Administración de lotes del adaptador de envío</span><span class="sxs-lookup"><span data-stu-id="4d8c4-103">Send Adapter Batch Management</span></span>  
 <span data-ttu-id="4d8c4-104">Cuando se usan transacciones en el envío, la misma transacción que creó BizTalk Server y se usó para el envío del sistema de destino se usa para la eliminación de los mensajes correspondientes una vez que ésta se ha enviado de forma correcta.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-104">When using transactions on the send side, the same transaction created by BizTalk Server and used for sending to the target system is used for the corresponding message deletion once it has been sent successfully.</span></span> <span data-ttu-id="4d8c4-105">Si no se producen errores, se puede finalizar la transacción, con lo que se anula la eliminación, y los datos permanecen en BizTalk Server y no en el sistema de destino.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-105">If anything fails, the transaction can be ended, in which case the deletion is aborted, and the data remains in BizTalk Server and not in the target system.</span></span> <span data-ttu-id="4d8c4-106">Esto evita que se dupliquen los mensajes.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-106">This prevents duplication of messages.</span></span> <span data-ttu-id="4d8c4-107">Las transacciones solo son compatibles con adaptadores de envío asíncronos.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-107">Transactions are only supported for asynchronous send adapters.</span></span> <span data-ttu-id="4d8c4-108">No debería usar transacciones con adaptadores de envío sincrónicos.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-108">You should not use transactions with synchronous send adapters.</span></span>  
  
 <span data-ttu-id="4d8c4-109">Pero el adaptador no puede finalizar simplemente la transacción; debe controlar también correctamente el estado de los mensajes.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-109">But the adapter cannot just end the transaction; it must also handle correctly the state of the messages it was given.</span></span> <span data-ttu-id="4d8c4-110">En concreto, el adaptador debería llamar a los métodos **reenviar**, **MoveToNextTransport**, y **MoveToSuspendQ** forma adecuada según el número de reintentos y si un transporte de copia de seguridad está disponible.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-110">Specifically, the adapter should call the methods **Resubmit**, **MoveToNextTransport**, and **MoveToSuspendQ** appropriately depending upon the retry count and whether a backup transport is available.</span></span>  
  
 <span data-ttu-id="4d8c4-111">Es importante colocar el **eliminar** y **SubmitResponse** operaciones juntas en un lote que usa la misma transacción.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-111">It is important to place the **Delete** and **SubmitResponse** operations together in a batch that uses the same transaction.</span></span> <span data-ttu-id="4d8c4-112">Los errores se controlan al final de la transacción (para asegurar que los datos solo se envían una vez a un sistema externo).</span><span class="sxs-lookup"><span data-stu-id="4d8c4-112">Failure is handled by ending the transaction (to ensure that data is only submitted once to an external system).</span></span> <span data-ttu-id="4d8c4-113">Pero todavía desea reenviar o llamar a **MoveToNextTransport** para el mensaje en BizTalk Server.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-113">But you still want to resubmit or call **MoveToNextTransport** for the message back on BizTalk Server.</span></span> <span data-ttu-id="4d8c4-114">Para ello, use un lote normal (no transaccional) independiente para estos tipos de operaciones.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-114">To do this, use a separate normal (non-transactional) batch for these types of operations.</span></span>  
  
 <span data-ttu-id="4d8c4-115">En la siguiente ilustración, se muestra el uso de lotes independientes para mensajes de respuesta.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-115">The following figure shows the use of separate batches for response messages.</span></span>  
  
 <span data-ttu-id="4d8c4-116">![Uso de un lote independiente para los mensajes de respuesta](../core/media/eawp-separatebatch.gif "EAWP_SeparateBatch")</span><span class="sxs-lookup"><span data-stu-id="4d8c4-116">![Using a separate batch for response messages](../core/media/eawp-separatebatch.gif "EAWP_SeparateBatch")</span></span>  
  
## <a name="sorting-the-send-side-transactional-batches-by-endpoint"></a><span data-ttu-id="4d8c4-117">Ordenar los lotes transaccionales de envío por extremo</span><span class="sxs-lookup"><span data-stu-id="4d8c4-117">Sorting the Send-Side Transactional Batches by Endpoint</span></span>  
 <span data-ttu-id="4d8c4-118">Los lotes de mensajes que envía BizTalk Server al adaptador pueden abarcar varios puertos de envío (o extremos).</span><span class="sxs-lookup"><span data-stu-id="4d8c4-118">Batches of messages sent by BizTalk Server to the adapter can span multiple send ports (or endpoints).</span></span> <span data-ttu-id="4d8c4-119">Dado que el adaptador desea normalmente tiene una transacción de un único punto de conexión, el adaptador debe ordenar los mensajes basándose en el puerto de envío (**SPName** o **OutboundTransportLocation**).</span><span class="sxs-lookup"><span data-stu-id="4d8c4-119">Because the adapter typically wants to have a transaction to a single endpoint, the adapter must sort the messages based on send port (**SPName** or **OutboundTransportLocation**).</span></span> <span data-ttu-id="4d8c4-120">Al hacerlo, el adaptador puede crear una transacción que abarque solo un determinado puerto de envío.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-120">By doing this, the adapter can create a transaction that spans only a particular send port.</span></span>  
  
 <span data-ttu-id="4d8c4-121">Por ejemplo, cuando un adaptador de envío FTP recibe un lote de mensajes de BizTalk Server, obtiene un lote mixto de mensajes para todos los puertos de envío FTP que estén activos en ese momento.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-121">For example, when an FTP send adapter receives a batch of messages from BizTalk Server, it gets a mixed batch of messages for all the currently active FTP send ports.</span></span> <span data-ttu-id="4d8c4-122">Esto sucede porque la API se basa en singleton, lo que significa que se carga solo un único adaptador FTP, no uno por puerto de envío.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-122">This happens because the API is singleton based, meaning that only a single FTP adapter is loaded, not one per send port.</span></span>  
  
 <span data-ttu-id="4d8c4-123">El adaptador debe ordenar primero en lotes independientes el lote de mensajes que ha proporcionado BizTalk Server, un lote por cada extremo.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-123">The adapter must first sort the batch of messages it was given by BizTalk Server into separate batches, one for each endpoint.</span></span> <span data-ttu-id="4d8c4-124">A continuación, puede tratar, a su vez, cada extremo y es posible que construya lotes de eliminación para cada uno.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-124">Then it can deal with each endpoint in turn and will probably construct delete batches for each endpoint.</span></span> <span data-ttu-id="4d8c4-125">Las clases genéricas reutilizables BaseAdapter del código de ejemplo de SDK funcionan del mismo modo.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-125">The BaseAdapter generic reusable classes in the SDK sample code work in the same way.</span></span>  
  
## <a name="sorting-for-dynamic-send"></a><span data-ttu-id="4d8c4-126">Ordenar envíos dinámicos</span><span class="sxs-lookup"><span data-stu-id="4d8c4-126">Sorting for Dynamic Send</span></span>  
 <span data-ttu-id="4d8c4-127">Una orquestación de BizTalk Server puede enviar un mensaje a un puerto que no se haya configurado, siempre y cuando proporcione detalles de configuración suficientes en el encabezado del mensaje y en la propia URL.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-127">A BizTalk Server orchestration can send a message to a port that has not been configured as long as it provides sufficient configuration details in the message header and in the URL itself.</span></span> <span data-ttu-id="4d8c4-128">BizTalk Server debe reconocer el protocolo de la URL.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-128">BizTalk Server must recognize the protocol of the URL.</span></span>  
  
 <span data-ttu-id="4d8c4-129">A la hora de ordenar mensajes, debería prestar atención al establecimiento de lo que define un extremo.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-129">When sorting messages, you should take care to establish what defines an endpoint.</span></span> <span data-ttu-id="4d8c4-130">Esto es especialmente útil en el caso de un envío dinámico.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-130">This is especially true in the case of a dynamic send.</span></span> <span data-ttu-id="4d8c4-131">Si solo el URI define el extremo, la operación es sencilla.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-131">If only the URI defines the endpoint, then things are simple.</span></span> <span data-ttu-id="4d8c4-132">Sin embargo, el servidor FTP puede usar los detalles de inicio de sesión del nombre de usuario en una sesión FTP para definir el extremo true.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-132">However, in an FTP session the user name logon details might be used by the FTP server to define the true endpoint.</span></span> <span data-ttu-id="4d8c4-133">En este caso, si el adaptador inicia sesión en una cuenta diferente, puede estar conectado a un directorio distinto.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-133">In this case, if the adapter logs in as a different account, it may be connected to a different directory.</span></span>  
  
 <span data-ttu-id="4d8c4-134">En algunos casos, no se conoce el extremo true hasta que haya ejecutado el comando de inicio de sesión único (SSO) empresarial **ValidateAndRedeemTicket**.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-134">In some cases, the true endpoint is not known until you have run the Enterprise Single Sign-On (SSO) command **ValidateAndRedeemTicket**.</span></span>  
  
 <span data-ttu-id="4d8c4-135">En el caso de MQSeries, se puede configurar la determinación de si se usan transacciones.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-135">In the case of MQSeries, the determination of whether to use transactions is configurable.</span></span> <span data-ttu-id="4d8c4-136">Teniendo en cuenta la arquitectura y el uso de un objeto COM+ remoto, es mejor distinguir un extremo transaccional de un extremo no transaccional.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-136">Given the architecture and the use of a remote COM+ object, it is best to regard a transactional endpoint as distinct from a non-transactional endpoint.</span></span>  
  
 <span data-ttu-id="4d8c4-137">En resumen, la ordenación de mensajes en los lotes de único extremo es, en ocasiones, una tarea importante y puede implicar tantos pasos adicionales como valores de contexto e incluso el resultado de una llamada a SSO.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-137">To summarize, sorting messages into their single endpoint batches is sometimes a nontrivial task and may involve such extra steps as considering the context values and even the result of a call to SSO.</span></span>  
  
## <a name="sorting-for-static-send"></a><span data-ttu-id="4d8c4-138">Ordenar envíos estáticos</span><span class="sxs-lookup"><span data-stu-id="4d8c4-138">Sorting for Static Send</span></span>  
 <span data-ttu-id="4d8c4-139">Si el extremo está configurado de forma estática, hay un único GUID en el contexto del mensaje denominado Id. de puerto estático (SPID).</span><span class="sxs-lookup"><span data-stu-id="4d8c4-139">If the endpoint is a statically configured endpoint there is a unique GUID on the message context called the static port ID (SPID).</span></span> <span data-ttu-id="4d8c4-140">Este valor puede usarse para ordenar el extremo.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-140">This value can be used for sorting the endpoint.</span></span> <span data-ttu-id="4d8c4-141">El siguiente código puede usarse para recuperarlo:</span><span class="sxs-lookup"><span data-stu-id="4d8c4-141">The following code can be used to retrieve it:</span></span>  
  
```  
string spid = (string)message.Context.Read("SPID", "http://schemas.microsoft.com/BizTalk/2003/system-properties");  
```  
  
 <span data-ttu-id="4d8c4-142">Éste es útil en el momento de considerar los problemas que ha provocado el marco de trabajo de configuración basado en definición de esquemas XML (XSD).</span><span class="sxs-lookup"><span data-stu-id="4d8c4-142">This is helpful when you consider the problems introduced by the XML Schema Definition (XSD)-based configuration framework.</span></span> <span data-ttu-id="4d8c4-143">Con este marco de trabajo, tiene una propiedad que puede ser parte de la clave de extremo incluida dentro de XML en una única propiedad de contexto.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-143">With this framework, you have a property that might be part of the endpoint key buried inside XML in a single context property.</span></span> <span data-ttu-id="4d8c4-144">Si tiene un SPID en el contexto, puede usarlo para ordenar el lote.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-144">If you have a SPID on the context, you can use that as a way to sort the batch.</span></span> <span data-ttu-id="4d8c4-145">De lo contrario, está creando un envío dinámico y deberá construir una clave alternativa con la que ordenar el lote.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-145">Otherwise you are doing a dynamic send and you need to construct an alternative key with which to sort the batch.</span></span>  
  
 <span data-ttu-id="4d8c4-146">En la siguiente ilustración, se muestra la ordenación de mensajes por extremo.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-146">The following figure shows message sorting by endpoint.</span></span>  
  
 <span data-ttu-id="4d8c4-147">![Ordenar mensajes por extremos](../core/media/eawp-sortbatch.gif "EAWP_SortBatch")</span><span class="sxs-lookup"><span data-stu-id="4d8c4-147">![Sorting messages by endpoint](../core/media/eawp-sortbatch.gif "EAWP_SortBatch")</span></span>  
  
 <span data-ttu-id="4d8c4-148">Recuerde que el número de reintentos de un mensaje no tiene en cuenta si el lote es correcto o contiene errores.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-148">Remember that the retry count of a message is not aware of the success or failure of a batch.</span></span> <span data-ttu-id="4d8c4-149">En el caso de los envíos, se pueden producir errores en un lote de mensajes porque haya errores en algunos de ellos.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-149">On the send side, a batch of messages may fail because a few messages in the batch have failed.</span></span> <span data-ttu-id="4d8c4-150">El adaptador debe tomar una determinación de cada mensaje que recibe.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-150">The adapter must make a determination for every message that it receives.</span></span> <span data-ttu-id="4d8c4-151">En el caso de lotes con errores, puede suponer que se vuelven a enviar todos los mensajes.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-151">In the failed batch scenario, you might assume that every message is resubmitted.</span></span> <span data-ttu-id="4d8c4-152">Sin embargo, si se vuelven a enviar todos los mensajes de un lote con errores, el número de reintentos (que mantiene el motor de BizTalk Server) aumenta de forma incorrecta incluso para los mensajes correctos porque se encuentran en el mismo lote que los que tienen errores.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-152">However, if all the messages in a failing batch are resubmitted, the retry count (which is maintained by the BizTalk Server engine) is incorrectly incremented even for the successful messages because they happen to be in the same batch as the failed messages.</span></span> <span data-ttu-id="4d8c4-153">En este caso, un adaptador podría modificar el lote de salida y reintentar los mensajes correctos con el sistema externo.</span><span class="sxs-lookup"><span data-stu-id="4d8c4-153">In this case, an adapter could reform the outbound batch and retry the successful messages against the external system.</span></span>
